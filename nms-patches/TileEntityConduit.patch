--- a/net/minecraft/server/TileEntityConduit.java
+++ b/net/minecraft/server/TileEntityConduit.java
@@ -7,18 +7,39 @@
 import java.util.UUID;
 import java.util.function.Predicate;
 import javax.annotation.Nullable;
+// CraftBukkit start
+import org.bukkit.craftbukkit.block.CraftBlock;
+import org.bukkit.craftbukkit.entity.CraftLivingEntity;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.event.Event;
+import org.bukkit.event.block.ConduitSelectTargetEvent;
+import org.bukkit.event.block.ConduitActivateEvent;
+import org.bukkit.event.block.ConduitValidateStructureEvent;
+import org.bukkit.event.entity.EntityDamageByBlockEvent;
+import org.bukkit.event.entity.EntityDamageEvent;
+// CraftBukkit end
 
 public class TileEntityConduit extends TileEntity implements ITickable {
 
     private static final Block[] e = new Block[] { Blocks.PRISMARINE, Blocks.PRISMARINE_BRICKS, Blocks.SEA_LANTERN, Blocks.DARK_PRISMARINE};
     public int a;
     private float f;
-    private boolean g;
+    public boolean g; // CraftBukkit - private -> public
     private boolean h;
-    private final List<BlockPosition> i;
-    private EntityLiving j;
-    private UUID k;
+    public final List<BlockPosition> i; // CraftBukkit - private -> public
+    public EntityLiving j; // CraftBukkit - private -> public
+    public UUID k; // CraftBukkit - private -> public
     private long l;
+    // CraftBukkit start
+    public static final Predicate<EntityLiving> defaultTargetPredicate = (living) -> living instanceof IMonster && living.ao(); // PAIL rename isInWater
+    public double searchRadius = 8.0D;
+    public float attackDamage = 4.0F;
+    public float ticksSinceActivated = 0.0F;
+    public Predicate<EntityLiving> targetPredicate = defaultTargetPredicate;
+    public Predicate<Entity> effectPredicate = IEntitySelector.f;
+    public int effectRange = -1;
+    public boolean isLocked = false;
+    // CraftBukkit end
 
     public TileEntityConduit() {
         this(TileEntityTypes.CONDUIT);
@@ -60,9 +81,10 @@
     public void Y_() {
         ++this.a;
         long i = this.world.getTime();
+        if (this.c()) ++ticksSinceActivated; // CraftBukkit - increment tick counter
 
         if (i % 40L == 0L) {
-            this.a(this.f());
+            this.a(this.f(), ConduitActivateEvent.Reason.NATURAL); // CraftBukkit - add reason
             if (!this.world.isClientSide && this.c()) {
                 this.h();
                 this.i();
@@ -89,6 +111,7 @@
     }
 
     private boolean f() {
+        if (isLocked) return this.c() || (this.h || this.i.size() >= 16); // CraftBukkit - use last check if locked
         this.i.clear();
 
         int i;
@@ -99,7 +122,11 @@
             for (j = -1; j <= 1; ++j) {
                 for (k = -1; k <= 1; ++k) {
                     BlockPosition blockposition = this.position.a(i, j, k);
-
+                    // CraftBukkit start - fire ConduitValidateStructureEvent
+                    ConduitValidateStructureEvent event = CraftEventFactory.callConduitStructureEvent(CraftBlock.at(this.world, this.position), CraftBlock.at(this.world, blockposition), ConduitValidateStructureEvent.Phase.IMMEDIATE_VICINITY);
+                    if (event.getResult() == Event.Result.DENY) return false;
+                    if (event.getResult() == Event.Result.ALLOW) continue;
+                    // CraftBukkit end
                     if (!this.world.B(blockposition)) {
                         return false;
                     }
@@ -119,7 +146,14 @@
                         IBlockData iblockdata = this.world.getType(blockposition1);
                         Block[] ablock = TileEntityConduit.e;
                         int k1 = ablock.length;
-
+                        // CraftBukkit - fire ConduitValidateStructureEvent
+                        ConduitValidateStructureEvent event = CraftEventFactory.callConduitStructureEvent(CraftBlock.at(this.world, this.position), CraftBlock.at(this.world, blockposition1), ConduitValidateStructureEvent.Phase.STRUCTURE);
+                        if (event.getResult() == Event.Result.DENY) continue;
+                        if (event.getResult() == Event.Result.ALLOW) {
+                            this.i.add(blockposition1);
+                            continue;
+                        }
+                        // CraftBukkit - end
                         for (int l1 = 0; l1 < k1; ++l1) {
                             Block block = ablock[l1];
 
@@ -138,12 +172,13 @@
 
     private void h() {
         int i = this.i.size();
-        int j = i / 7 * 16;
+        int j = this.isLocked ? effectRange : (i / 7 * 16); // CraftBukkit - use effectRange if locked.
+        if(!isLocked) effectRange = j; // CraftBukkit - set effectRange with updated range if not locked
         int k = this.position.getX();
         int l = this.position.getY();
         int i1 = this.position.getZ();
         AxisAlignedBB axisalignedbb = (new AxisAlignedBB((double) k, (double) l, (double) i1, (double) (k + 1), (double) (l + 1), (double) (i1 + 1))).g((double) j).b(0.0D, (double) this.world.getHeight(), 0.0D);
-        List list = this.world.a(EntityHuman.class, axisalignedbb);
+        List list = this.world.a(EntityHuman.class, axisalignedbb, effectPredicate);
 
         if (!list.isEmpty()) {
             Iterator iterator = list.iterator();
@@ -152,7 +187,7 @@
                 EntityHuman entityhuman = (EntityHuman) iterator.next();
 
                 if (this.position.m(new BlockPosition(entityhuman)) <= (double) j && entityhuman.ao()) {
-                    entityhuman.addEffect(new MobEffect(MobEffects.CONDUIT_POWER, 260, 0, true, true));
+                    entityhuman.addEffect(new MobEffect(MobEffects.CONDUIT_POWER, 260, 0, true, true), org.bukkit.event.entity.EntityPotionEffectEvent.Cause.CONDUIT); // CraftBukkit
                 }
             }
 
@@ -169,20 +204,33 @@
             this.j = this.l();
             this.k = null;
         } else if (this.j == null) {
-            List list = this.world.a(EntityLiving.class, this.k(), (entityliving) -> {
-                return entityliving instanceof IMonster && entityliving.ao();
-            });
+            List list = this.world.a(EntityLiving.class, this.k(), targetPredicate); // CraftBukkit - use our predicate so we can change it
 
             if (!list.isEmpty()) {
+                // CraftBukkit - fire ConduitSelectTargetEvent
                 this.j = (EntityLiving) list.get(this.world.random.nextInt(list.size()));
+                ConduitSelectTargetEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callConduitTargetEvent(CraftBlock.at(world, position), (org.bukkit.entity.LivingEntity) j.getBukkitEntity());
+                if (event.isCancelled() || event.getTarget() == null) {
+                    this.j = null;
+                    return;
+                }
+                this.j = ((CraftLivingEntity) event.getTarget()).getHandle();
+                // CraftBukkit end
             }
-        } else if (!this.j.isAlive() || this.position.m(new BlockPosition(this.j)) > 8.0D) {
+        } else if (!this.j.isAlive() || this.position.m(new BlockPosition(this.j)) > searchRadius) { // CraftBukkit - use our range instead of default
             this.j = null;
         }
 
         if (this.j != null) {
-            this.world.a((EntityHuman) null, this.j.locX, this.j.locY, this.j.locZ, SoundEffects.BLOCK_CONDUIT_ATTACK_TARGET, SoundCategory.BLOCKS, 1.0F, 1.0F);
-            this.j.damageEntity(DamageSource.MAGIC, 4.0F);
+            // CraftBukkit start
+            CraftEventFactory.blockDamage = CraftBlock.at(this.world, this.position);
+            EntityDamageByBlockEvent event = new EntityDamageByBlockEvent(CraftBlock.at(this.world, this.position), j.getBukkitEntity(), EntityDamageEvent.DamageCause.CONDUIT, attackDamage);
+            if (CraftEventFactory.callEvent(event).isCancelled()) return;
+            if (this.j.damageEntity(DamageSource.MAGIC, (float) event.getDamage())) {
+                this.world.a((EntityHuman) null, this.j.locX, this.j.locY, this.j.locZ, SoundEffects.BLOCK_CONDUIT_ATTACK_TARGET, SoundCategory.BLOCKS, 1.0F, 1.0F);
+            }
+            CraftEventFactory.blockDamage = null;
+            // CraftBukkit end
         }
 
         if (entityliving != this.j) {
@@ -210,12 +258,12 @@
         int j = this.position.getY();
         int k = this.position.getZ();
 
-        return (new AxisAlignedBB((double) i, (double) j, (double) k, (double) (i + 1), (double) (j + 1), (double) (k + 1))).g(8.0D);
+        return (new AxisAlignedBB((double) i, (double) j, (double) k, (double) (i + 1), (double) (j + 1), (double) (k + 1))).g(searchRadius); // CraftBukkit - use our range instead of default
     }
 
     @Nullable
     private EntityLiving l() {
-        List list = this.world.a(EntityLiving.class, this.k(), (entityliving) -> {
+        List list = this.world.a(EntityLiving.class, this.k(), (Predicate<EntityLiving>) (entityliving) -> { // CraftBukkit - decompile error
             return entityliving.getUniqueID().equals(this.k);
         });
 
@@ -264,12 +312,18 @@
         return this.g;
     }
 
-    private void a(boolean flag) {
+    public void a(boolean flag, ConduitActivateEvent.Reason reason) { // CraftBukkit private -> public
         if (flag != this.g) {
+            // CraftBukkit - start - fire ConduitActivateEvent
+            ConduitActivateEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callConduitActivateEvent(CraftBlock.at(this.world, this.position), flag, reason);
+            if (event.isCancelled() || event.isActive() == this.g) return; // CraftBukkit - return if cancelled or if 'isActive' is the same as the conduit's status
+            flag = event.isActive();
+            // CraftBukkit end
             this.a(flag ? SoundEffects.BLOCK_CONDUIT_ACTIVATE : SoundEffects.BLOCK_CONDUIT_DEACTIVATE);
         }
 
         this.g = flag;
+        if (!this.g) ticksSinceActivated = 0.0F; // CraftBukkit - reset active counter
     }
 
     private void b(boolean flag) {
